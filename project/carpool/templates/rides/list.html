{% extends 'base.html' %}
{% load static %}
{% load duration %}
{% load i18n %}

{% block extrahead %}
<link rel="stylesheet" href="{% static 'vendors/bootstrap-icons/bootstrap-icons.min.css' %}">
<link rel="stylesheet" href="{% static 'vendors/choices-js/public/assets/styles/choices.min.css' %}" />


<style>
    /* Choices-js z-index */
    .choices__list--dropdown,
    .choices__list[aria-expanded] {
        z-index: 2; /* greater than z-index of stretched-link */
    }

    .choices__inner {
        background-color: #ffffff !important; /* white background instead of grey */
        border: 1px solid #cccccc; /* lighter border */
    }

    .choices__placeholder {
        opacity: 1;
    }

    .circle {
        width: 10px;
        height: 10px;
        border: 2px solid black;
        border-radius: 50%;
        background-color: white;
        align-self: center;
        flex-shrink: 0;
    }

    .line {
        background-color: #1b1b1b;
        flex: 1;
        border-radius: 2px;
        align-self: center;
        margin: 2px 0;
        width: 4px;
    }
</style>
{% endblock extrahead %}

{% block content %}
<div class="container mt-3">
    {% if user.is_authenticated %}
    <div class="card mb-4 text-bg-light">
        <div class="card-body">
            <form method="GET">
                <input type="hidden" name="d_fulltext" id="id_d_fulltext" value="{{ d_fulltext }}">
                <input type="hidden" name="d_latlng" id="id_d_latlng" value="{{ filter_departure }}">
                <input type="hidden" name="a_fulltext" id="id_a_fulltext" value="{{ a_fulltext }}">
                <input type="hidden" name="a_latlng" id="id_a_latlng" value="{{ filter_arrival }}">
                
                <div class="row">
                    <div class="col mb-3 mb-lg-0">
                        <!-- Autcomplete for departure --
                        <select class="form-select" id="departure" value="{{ filter_departure }}"></select>-->
                        <select class="form-select" id="departure" name="departure" data-selected="{{ filter_departure }}"></select>

                    </div>

                    <div class="col-lg mb-3 mb-lg-0">
                        <!-- Autcomplete for arrival -->
                        <select class="form-select" id="arrival" value="{{ filter_arrival }}"></select>
                    </div>

                    <div class="col-lg d-grid align-self-center mb-3 mb-lg-0">
                        <input type="date" id="start_dt" name="start_dt" class="form-control" value="{{ filter_date|date:"Y-m-d" }}" required>
                    </div>

                    <div class="col d-grid align-self-center mb-md-3 mb-lg-0">
                        <button type="submit" class="btn btn-primary">{% translate "Search" %}</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    <div class="row">
        <!-- <div class="col-xl-3 mb-3">
            <h5>Sort by</h5>
            <form method="get">
                <div class="mb-3">
                    <select name="sort" class="form-select" disabled></select>
                </div>
            </form>
	</div>-->
        <div class="col-md ms-auto">

            <!-- End demo card -->
            {% regroup rides by ride_date as date_list %}

            {% for ridebydate in date_list %}
                <span class="fw-semibold fs-2">
                    {{ ridebydate.grouper|date:"l j F Y" }}
                </span>
                {% for ride in ridebydate.list %}
                    <div class="card mb-3">
                        <div class="card-body">
                            <a href="{{ ride.get_absolute_url }}" class="stretched-link"></a>
                            <div class="d-flex justify-content-between">
                                <div class="d-grid">
                                    <div class="d-flex flex-row">
                                        <div class="d-flex flex-column me-2 gap-1">
                                            <span class="fw-semibold">{{ ride.start_dt|date:"H:i" }}</span>
                                            <span class="text-muted small text-end">{{ ride.duration|duration }}</span>
                                            <span class="fw-semibold">{{ ride.end_dt|date:"H:i" }}</span>
                                        </div>
                                        <div class="d-flex flex-column mx-1 my-1">
                                            <div class="circle"></div>
                                            <div class="line"></div>
                                            <div class="circle"></div>
                                        </div>
                                        <div class="d-flex flex-column ms-2">
                                            <span>{{ ride.start_loc.city }}</span>
                                            <span class="h-100"></span>
                                            <span>{{ ride.end_loc.city }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="d-flex flex-column">

                                    <div class="fw-bold text-primary fs-2 text-end">
                                        {{ ride.price }} â‚¬
                                    </div>
                                    <div class="text-end">
                                        {% if "CASH" in ride.payment_method %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor"
                                            class="bi bi-piggy-bank-fill" viewBox="0 0 16 16">
                                            <path
                                                d="M7.964 1.527c-2.977 0-5.571 1.704-6.32 4.125h-.55A1 1 0 0 0 .11 6.824l.254 1.46a1.5 1.5 0 0 0 1.478 1.243h.263c.3.513.688.978 1.145 1.382l-.729 2.477a.5.5 0 0 0 .48.641h2a.5.5 0 0 0 .471-.332l.482-1.351c.635.173 1.31.267 2.011.267.707 0 1.388-.095 2.028-.272l.543 1.372a.5.5 0 0 0 .465.316h2a.5.5 0 0 0 .478-.645l-.761-2.506C13.81 9.895 14.5 8.559 14.5 7.069q0-.218-.02-.431c.261-.11.508-.266.705-.444.315.306.815.306.815-.417 0 .223-.5.223-.461-.026a1 1 0 0 0 .09-.255.7.7 0 0 0-.202-.645.58.58 0 0 0-.707-.098.74.74 0 0 0-.375.562c-.024.243.082.48.32.654a2 2 0 0 1-.259.153c-.534-2.664-3.284-4.595-6.442-4.595m7.173 3.876a.6.6 0 0 1-.098.21l-.044-.025c-.146-.09-.157-.175-.152-.223a.24.24 0 0 1 .117-.173c.049-.027.08-.021.113.012a.2.2 0 0 1 .064.199m-8.999-.65a.5.5 0 1 1-.276-.96A7.6 7.6 0 0 1 7.964 3.5c.763 0 1.497.11 2.18.315a.5.5 0 1 1-.287.958A6.6 6.6 0 0 0 7.964 4.5c-.64 0-1.255.09-1.826.254ZM5 6.25a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0" />
                                        </svg>
                                        {% endif %}
                                        {% if "WIRE" in ride.payment_method %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor"
                                            class="bi bi-bank2" viewBox="0 0 16 16">
                                            <path
                                                d="M8.277.084a.5.5 0 0 0-.554 0l-7.5 5A.5.5 0 0 0 .5 6h1.875v7H1.5a.5.5 0 0 0 0 1h13a.5.5 0 1 0 0-1h-.875V6H15.5a.5.5 0 0 0 .277-.916zM12.375 6v7h-1.25V6zm-2.5 0v7h-1.25V6zm-2.5 0v7h-1.25V6zm-2.5 0v7h-1.25V6zM8 4a1 1 0 1 1 0-2 1 1 0 0 1 0 2M.5 15a.5.5 0 0 0 0 1h15a.5.5 0 1 0 0-1z" />
                                        </svg>
                                        {% endif %}
                                        {% if "LYF" in ride.payment_method %}
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 300 300"
                                            preserveAspectRatio="xMidYMid meet" style="vertical-align:middle;">
                                            <g transform="translate(0,300) scale(0.1,-0.1)" fill="#ff4e50" stroke="none">
                                                <path
                                                    d="M1280 2714 c-506 -92 -906 -495 -995 -1002 -19 -111 -19 -313 0 -424 90 -511 492 -913 1003 -1003 111 -19 313 -19 424 0 511 90 913 492 1003 1003 19 111 19 313 0 424 -90 511 -492 913 -1003 1003 -107 18 -328 18 -432 -1z m-500 -1064 l0 -370 160 0 161 0 19 -45 c11 -25 32 -61 46 -80 l26 -35 -286 0 -286 0 0 450 0 450 80 0 80 0 0 -370z m1508 335 l42 -20 -30 -63 c-26 -56 -32 -62 -49 -52 -11 5 -40 10 -65 10 -36 0 -48 -5 -65 -26 -12 -15 -21 -40 -21 -55 l0 -29 80 0 80 0 0 -80 0 -80 -80 0 -80 0 0 -235 0 -236 -82 3 -83 3 -3 233 -2 232 -45 0 -45 0 0 75 0 75 45 0 c44 0 45 1 45 33 0 85 46 171 114 213 36 22 50 25 121 22 52 -3 95 -11 123 -23z m-948 -421 c0 -149 3 -193 16 -219 40 -85 145 -95 214 -21 25 27 25 30 28 227 l3 199 85 0 85 0 -3 -322 c-3 -305 -4 -326 -24 -369 -29 -61 -85 -116 -151 -146 -50 -23 -64 -25 -156 -21 -105 5 -191 29 -238 67 l-22 18 26 57 c15 32 30 56 34 54 5 -2 35 -17 67 -32 147 -71 297 -28 321 93 l7 34 -33 -25 c-103 -76 -265 -61 -357 33 -73 74 -77 89 -80 337 l-3 222 90 0 91 0 0 -186z m999 -279 c32 -16 41 -33 41 -76 0 -42 -14 -64 -49 -79 -61 -25 -121 14 -121 78 0 74 63 112 129 77z" />
                                            </g>
                                        </svg>
                                        {% endif %}
                                    </div>

                                </div>
                            </div>
                        </div>
                        {% if user.is_authenticated %}
                        <div class="card-footer bg-white d-flex flex-row">
                            <img src="{% static 'img/avatar.jpg' %}"
                                class="rounded-circle" width="30" />
                            <span class="ms-2 my-auto fw-semibold text-muted">{{ ride.driver }}</span>
                            <div class="d-flex flex-row gap-2 ms-auto">
                                <span class="my-auto text-muted">{{ ride.remaining_seats }} {% translate "remaining seats" %}</span>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                {% endfor %}
            {% empty %}
            <div class="card">
                <div class="card-body mb-3">
                    <h5 class="card-title">{% translate "No rides found" %}</h5>
                    <p class="card-text">{% translate "Consider taking the train or posting the first ride on the platform." %}</p>
                    <div class="text-center">
                        <a href="{% url 'carpool:create' %}" class="btn btn-primary">{% translate "Publish a ride" %}</a>
                    </div>


                </div>
            </div>
            {% endfor %}
            <nav aria-label="Page navigation" class="my-3">
                <ul class="pagination justify-content-center">
                    <!-- Previous page -->
                    <li class="page-item {% if not page_obj.has_previous %}disabled{% endif %}">
                        <a class="page-link"
                            href="{% if page_obj.has_previous %}?page={{ page_obj.previous_page_number }}&{{ querystring|safe }}{% endif %}"
                            aria-label="{% translate 'Previous' %}">
                            {% translate "Previous" %}
                        </a>
                    </li>
                    {% for i in page_obj.paginator.page_range %}
                        {% if i == 1 or i == page_obj.paginator.num_pages or i >= page_obj.number|add:'-1' and i <= page_obj.number|add:'1' %}
                            <li class="page-item {% if page_obj.number == i %}active{% endif %}">
                                <a class="page-link" href="?page={{ i }}&{{ querystring|safe }}">{{ i }}</a>
                            </li>
                        {% elif i == page_obj.number|add:'-2' or i == page_obj.number|add:'2' %}
                            <li class="page-item">
                                <span class="page-link pe-none">â€¦</span>
                            </li>
                        {% endif %}
                    {% endfor %}

                    <!-- Next page -->
                    <li class="page-item {% if not page_obj.has_next %}disabled{% endif %}">
                        <a class="page-link"
                            href="{% if page_obj.has_next %}?page={{ page_obj.next_page_number }}&{{ querystring|safe }}{% endif %}"
                            aria-label="{% translate 'Next' %}">
                            {% translate "Next" %}
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</div>

{% endblock %}

{% block extrascript %}
{% if user.is_authenticated %}
<script src="{% static 'vendors/choices-js/public/assets/scripts/choices.min.js' %}"></script>

<script>
    // Constants
    const WAITING_BEFORE_REQUEST = 500;


    // Autocomplete elements
    const departureEl = document.getElementById('departure');
    const arrivalEl = document.getElementById('arrival');

    // departure information
    const hDepartureFullText = document.getElementById('id_d_fulltext');
    const hDepartureLatLng = document.getElementById('id_d_latlng');

    // arrival information
    const hArrivalFullText = document.getElementById('id_a_fulltext');
    const hArrivalLatLng = document.getElementById('id_a_latlng');

    // Initialize Choices.js for autocomplete
    const departure = new Choices(departureEl, {
        removeItemButton: true,
        placeholder: true,
        placeholderValue: "{% translate 'Search for an address of departure' %}",
        noChoicesText: "{% translate 'No address found' %}",

    })
    const arrival = new Choices(arrivalEl, {
        removeItemButton: true,
        placeholder: true,
        placeholderValue: "{% translate 'Search for an address of arrival' %}",
        noChoicesText: "{% translate 'No address found' %}",
    })

    // =================================================================
    // Event listeners for addresses search
    // =================================================================
    departureEl.addEventListener('change', (event) => {
        const selected = departure.getValue();

        hDepartureFullText.value = selected.label;
        hDepartureLatLng.value = `${selected.customProperties.longitude},${selected.customProperties.latitude}`;
    });

    arrivalEl.addEventListener('change', (event) => {
        const selected = arrival.getValue();

        hArrivalFullText.value = selected.label;
        hArrivalLatLng.value = `${selected.customProperties.longitude},${selected.customProperties.latitude}`;
    });

    departure.passedElement.element.addEventListener('search', async (event) => {
        clearTimeout(event.target.timer);

        event.target.timer = setTimeout(async () => {
            try {
                const response = await fetch(`/api/completion/?text=${event.detail.value}`);
                const data = await response.json();
                if (data.status !== 'OK') {
                    return;
                }
                departure.clearChoices();
                departure.setChoices(data.results, 'value', 'fulltext', true);
            } catch (error) {
                console.error('Error fetching addresses:', error);
            }
        }, WAITING_BEFORE_REQUEST);
    })

    departure.passedElement.element.addEventListener('removeItem', (event) => {
        hDepartureFullText.value = '';
        hDepartureLatLng.value = '';
    });


    arrival.passedElement.element.addEventListener('search', async (event) => {
        clearTimeout(event.target.timer);

        event.target.timer = setTimeout(async () => {
            try {
                const response = await fetch(`/api/completion/?text=${event.detail.value}`);
                const data = await response.json();
                if (data.status !== 'OK') {
                    return;
                }
                arrival.clearChoices();
                arrival.setChoices(data.results, 'value', 'fulltext', true);
            } catch (error) {
                console.error('Error fetching addresses:', error);
            }
        }, WAITING_BEFORE_REQUEST);
    })

    arrival.passedElement.element.addEventListener('removeItem', (event) => {
        hArrivalFullText.value = '';
        hArrivalLatLng.value = '';
    });


    // When loading the page, set the values if they are existing in the URL
    const urlParams = new URLSearchParams(window.location.search);
    const dFulltext = urlParams.get('d_fulltext');
    const dLatLng = urlParams.get('d_latlng');
    const aFulltext = urlParams.get('a_fulltext');
    const aLatLng = urlParams.get('a_latlng');
    var d_latitude = undefined;
    var d_longitude = undefined;
    var a_latitude = undefined;
    var a_longitude = undefined;

    // a_latlng and d_latlng are in the format "latitude,longitude"
    if (dLatLng) {
        [d_latitude, d_longitude] = dLatLng.split(',');
    }

    if (aLatLng) {
        [a_latitude, a_longitude] = aLatLng.split(',');
    }

    if (dFulltext && dLatLng) {
        departure.setValue([{
            value: dLatLng,
            label: dFulltext,
            customProperties: {
                latitude: d_latitude,
                longitude: d_longitude
            },
            selected: true
        }]);
        hDepartureFullText.value = dFulltext;
        hDepartureLatLng.value = dLatLng;
    }

    if (aFulltext && aLatLng) {
        arrival.setValue([{
            value: aLatLng,
            label: aFulltext,
            customProperties: {
                latitude: a_latitude,
                longitude: a_longitude
            },
            selected: true
        }]);
        hArrivalFullText.value = aFulltext;
        hArrivalLatLng.value = aLatLng;
    }

</script>
{% endif %}
{% endblock extrascript %}
