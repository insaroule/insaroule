{% extends 'base.html' %}


{% block extrahead %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<style>
    #departure {
        z-index: 999;
    }
    #arrival {
        z-index: 998;
    }

    .circle {
        width: 10px;
        height: 10px;
        border: 2px solid black;
        border-radius: 50%;
        background-color: white;
        align-self: center;
        flex-shrink: 0;
    }

    .line {
        background-color: #1b1b1b;
        flex: 1;
        border-radius: 2px;
        align-self: center;
        margin: 2px 0;
        width: 4px;
    }
</style>
{% endblock extrahead %}

{% block content %}
<input type="hidden" id="id_departure_fullname" value="{{ ride.start_loc.label }}">
<input type="hidden" id="id_departure_lat" value="{{ ride.start_loc.lat }}">
<input type="hidden" id="id_departure_lng" value="{{ ride.start_loc.lng }}">
<input type="hidden" id="id_arrival_fullname" value="{{ ride.end_loc.label }}">
<input type="hidden" id="id_arrival_lat" value="{{ ride.end_loc.lat }}">
<input type="hidden" id="id_arrival_lng" value="{{ ride.end_loc.lng }}">

<div class="container">
    <h1>{{ ride.start_dt|date:"l j F Y" }}</h1>
    <!--
    <div class="d-flex justify-content-center mb-4">
        <div class="shadow-sm rounded" 
             style="display: inline-flex; align-items: center; justify-content: center; padding: 50px 50px; background-color: #d2f4fa; border-radius: 40px;">
            
            <div class="card-body">
                <div>
                    <h2 class="card-title">
                        <div class="row">
                            <div class="col">
                               <div>{{ ride.start_loc.label }}</div> 
                                <div><h5>{{ ride.start_dt|date:"H\\hi" }}</h5></div>
                            </div>
                            <div class="col">
                                → 
                            </div>
                            <div class="col">
                                <div>{{ ride.end_loc.label }}</div> 
                                <div><h5>{{ ride.end_dt|date:"H\\hi" }}</h5></div>
                            </div>
                        </div>
                    </h2>   
                    <p class="text-muted small mb-0">
                        Durée : {{ ride.humanized_duration }}
                    </p>             
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col">
            <div class="d-flex justify-content-center mb-4">
                <div class="shadow-sm rounded" 
                    style="display: inline-flex; align-items: center; justify-content: center; padding: 50px 50px; background-color: #d2f4fa; border-radius: 40px; width: 18rem;">
                    
                    <div>
                        <p class="mb-0">Conducteur : {{ ride.driver.username }}</p>
                        <p class="mb-0">Véhicule : {{ ride.vehicle.name }}</p>
                        <p class="mb-0">Nombre de places restantes : {{ ride.vehicle.seats }} </p>
                    </div>
                    
                </div>
            </div>
        </div>
        <div class="col">
            <div class="d-flex justify-content-center mb-4">
                    <div class="text-end">
                        <h2 class="text-primary">{{ ride.price }} €</h2>
                        
                    </div>
            </div>
        </div>
    </div> -->
    
    <div class="card mb-3 mx-auto" style="background-color: #d2f4fa; max-width: 1000px; ">
        <h3>
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div class="d-grid">
                        <div class="d-flex flex-row">
                            <div class="d-flex flex-column me-2 gap-1">
                                <span class="fw-semibold">{{ ride.start_dt|date:"H:i" }}</span>
                                <span class="text-muted small text-end">{{ ride.humanized_duration }}</span>
                                <span class="fw-semibold">{{ ride.end_dt|date:"H:i" }}</span>
                            </div>
                            <div class="d-flex flex-column mx-1 my-1">
                                <div class="circle"></div>
                                <div class="line"></div>
                                <div class="circle"></div>
                            </div>
                            <div class="d-flex flex-column ms-2">
                                <span>{{ ride.start_loc.label }}</span>
                                <span class="h-100"></span>
                                <span>{{ ride.end_loc.label }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex flex-column">
                        <div class="fw-bold text-primary fs-2 text-end">
                            {{ ride.price }} €
                        </div>
                        <div class="small">
                            {{ ride.payment_method }}
                        </div>
                    </div>
                </div>
            </div>
        </h3>
        <div class="card-footer bg-white d-flex flex-row">
            <img src="https://static.vecteezy.com/system/resources/previews/009/292/244/non_2x/default-avatar-icon-of-social-media-user-vector.jpg"
                class="rounded-circle" width="30" />
            <span class="ms-2 my-auto fw-semibold text-muted">{{ ride.driver }}</span>
            <div class="d-flex flex-row gap-2 ms-auto">
                <span class="my-auto text-muted">{{ ride.vehicle.seats }} remaining seats</span>
            </div>
        </div>
    </div> 
    <div class="row">
        <div class="col">
            <div class="card mb-3 " style="background-color: #d2f4fa; max-width: 400px; height : 300px">
                <div class="card-body">
                    <div class="d-flex justify-content-between h-100" >
                        <div class="d-flex ">
                            <div class="d-flex flex-column">                                    

                                <div class="d-flex flex-row">

                                    <div>
                                        <img src="https://static.vecteezy.com/system/resources/previews/009/292/244/non_2x/default-avatar-icon-of-social-media-user-vector.jpg"
                                        class="rounded-circle me-3" width="70" />
                                    </div>
                                    <div class="d-flex flex-column">
                                        <span class="text-muted small">Vehicule : {{ ride.vehicle.name }}</span>   
                                    
                                        <span class="text-muted small">Color : {{ ride.vehicle.color }}</span>
                                    </div>
                                </div>
                                <div>
                                    <span class="ms-2 my-auto fw-semibold text-muted">{{ ride.driver }}</span>
                                </div>                                
                            </div>
                        </div>
                        <div class="d-flex flex-column justify-content-center">
                                <div>Contact : </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col">
            <div id="ride-map" style="height: 50vh"></div>
        </div>
    </div>
</div>


{% endblock %}

{% block extrascript %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>




<script>
    let route = null;
    // Récupération des valeurs dans les inputs cachés
    const departurename = document.getElementById('id_departure_fullname').value;
    const arrivalname = document.getElementById('id_arrival_fullname').value;

    const departureLat = parseFloat(document.getElementById('id_departure_lat').value);
    const departureLng = parseFloat(document.getElementById('id_departure_lng').value);
    const arrivalLat = parseFloat(document.getElementById('id_arrival_lat').value);
    const arrivalLng = parseFloat(document.getElementById('id_arrival_lng').value);

    // Initialisation de la carte Leaflet centrée sur un point moyen
    const centerLat = (departureLat + arrivalLat) / 2;
    const centerLng = (departureLng + arrivalLng) / 2;

    var map = L.map('ride-map', 
    {
        doubleClickZoom: false,
        boxZoom: false,
        dragging: false,
        doubleClickZoom: false,
        scrollWheelZoom: false,
        zoomControl: false,

    }).setView([centerLat, centerLng], 6.4);


    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    document.addEventListener('DOMContentLoaded', function () {
        

        // Ajout des marqueurs de départ et d’arrivée
        const markerDeparture = L.marker([departureLat, departureLng]).addTo(map).bindPopup(departurename);
        const markerArrival = L.marker([arrivalLat, arrivalLng]).addTo(map).bindPopup(arrivalname);

        // Tracer une ligne entre départ et arrivée
        if (markerDeparture && markerArrival) {
            // If both markers are set, fetch the route
            getRouteFromCoordinates(
                markerDeparture.getLatLng().lat,
                markerDeparture.getLatLng().lng,
                markerArrival.getLatLng().lat,
                markerArrival.getLatLng().lng
            );
        }
    });


    function getRouteFromCoordinates(departureLat, departureLng, arrivalLat, arrivalLng) {
        console.log("Fetching route from coordinates:", departureLat, departureLng, arrivalLat, arrivalLng);
        const start = encodeURIComponent(`${departureLng},${departureLat}`); 
        const end = encodeURIComponent(`${arrivalLng},${arrivalLat}`);

        const url = `https://data.geopf.fr/navigation/itineraire?resource=bdtopo-osrm&start=${start}&end=${end}&profile=car&optimization=fastest&geometryFormat=geojson&getSteps=true&getBbox=true&distanceUnit=kilometer&timeUnit=hour&crs=EPSG%3A4326`;
        fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        }).then(data => {
            // Show geometry on the map
            if (data.geometry) {
                // Remove previous route if it exists
                if (route) {
                    map.removeLayer(route);
                }
                route = L.geoJSON(data.geometry, {
                    style: {
                        color: '#3388ff',
                        weight: 5,
                        opacity: 0.7
                    }
                }).addTo(map);
                // TODO: store duration
                
                // Fit the map to the route bounds
                map.fitBounds(route.getBounds(), { padding: [50, 50] });
            } else {
                console.error('No geometry found in the response');
            }


            console.log(data);

        }).catch(error => {
            console.error('Error fetching route:', error);
        });
    };




















</script>
    
    




<!--



<script>
    // Récupération des coordonnées depuis Django (backend)
    const startLat = parseFloat("{{ ride.start_loc.lat }}");
    const startLng = parseFloat("{{ ride.start_loc.lng }}");
    const endLat = parseFloat("{{ ride.end_loc.lat }}");
    const endLng = parseFloat("{{ ride.end_loc.lng }}");


    // Centrer la carte entre les deux points
    const map = L.map('map').setView([(startLat + endLat) / 2, (startLng + endLng) / 2], 10);

    // Fond de carte (OpenStreetMap)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Marqueur de départ
    L.marker([startLat, startLng])
        .addTo(map)
        .bindPopup("<b>Départ</b><br>{{ ride.start_loc.label }}")
        .openPopup();

    // Marqueur d’arrivée
    L.marker([endLat, endLng])
        .addTo(map)
        .bindPopup("<b>Arrivée</b><br>{{ ride.end_loc.label }}");

    // Ligne entre départ et arrivée
    const routeLine = L.polyline([
        [startLat, startLng],
        [endLat, endLng]
    ], { color: 'blue' }).addTo(map);

    // Ajuste automatiquement le zoom pour englober les deux points
    map.fitBounds(routeLine.getBounds());

    
    setTimeout(() => {
        map.invalidateSize();
    }, 200);
</script>
-->
{% endblock extrascript %}